<ui:FluentWindow x:Class="LocalAniHubFront.Views.Windows.PlayerWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:LocalAniHubFront.ViewModels.Windows"
        xmlns:vlc="clr-namespace:LibVLCSharp.WPF;assembly=LibVLCSharp.WPF"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        Title="LibVLCSharp 播放器" Height="650" Width="1100"
        AllowsTransparency="False"
        WindowBackdropType="Mica"   
        WindowCornerPreference="Round"
        Loaded="Window_Loaded"
        Closing="Window_Closing"
        ExtendsContentIntoTitleBar="True"
        KeyDown="Window_KeyDown">

    <ui:FluentWindow.Resources>
        <Style x:Key="SliderRepeatButtonStyle" TargetType="RepeatButton">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RepeatButton">
                        <Rectangle Fill="Transparent"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="Focusable" Value="False"/>
        </Style>


        <ControlTemplate x:Key="FluentSliderTemplate" TargetType="Slider">
            <Grid>
                <Track x:Name="PART_Track">
                    <Track.DecreaseRepeatButton>
                        <RepeatButton Command="Slider.DecreaseLarge" Style="{StaticResource SliderRepeatButtonStyle}"/>
                    </Track.DecreaseRepeatButton>
                    <Track.Thumb>
                        <Thumb x:Name="Thumb" DragStarted="PositionSlider_DragStarted" DragCompleted="PositionSlider_DragCompleted"/>
                    </Track.Thumb>
                    <Track.IncreaseRepeatButton>
                        <RepeatButton Command="Slider.IncreaseLarge" Style="{StaticResource SliderRepeatButtonStyle}"/>
                    </Track.IncreaseRepeatButton>
                </Track>
            </Grid>
        </ControlTemplate>
    </ui:FluentWindow.Resources>

    <ui:FluentWindow.DataContext>
        <vm:PlayerViewModel x:Name="ViewModel" />
    </ui:FluentWindow.DataContext>

    <ui:FluentWindow.InputBindings>
        <!-- F11 切换全屏 
        <KeyBinding Key="F11" Command="{Binding ToggleFullScreenCommand}"/>-->
        <!-- Esc 退出全屏 
        <KeyBinding Key="Escape" Command="{Binding ExitFullScreenCommand}"/>-->

        <!-- 左右箭头 快进快退 -->
        <KeyBinding Key="Right" Command="{Binding SkipCommand}" CommandParameter="5000"/>
        <KeyBinding Key="Left"  Command="{Binding SkipCommand}" CommandParameter="-5000"/>

        <!-- X:减速0.1 C:加速0.1 Z:恢复原速 -->
        <KeyBinding Key="X" Command="{Binding DecreaseSpeedCommand}"/>
        <KeyBinding Key="C" Command="{Binding IncreaseSpeedCommand}"/>
        <KeyBinding Key="Z" Command="{Binding ResetSpeedCommand}"/>

        <!-- S:截图-->
        <!--截图保存至该视频对应的条目的素材文件夹中-->
        <!--命名如："某某片_ep2_000526_202505132130.png"-->
        <KeyBinding Key="S" Command="{Binding SnapshotCommand}"/>
    </ui:FluentWindow.InputBindings>



    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <ui:TitleBar x:Name="TitleBar"
                     Grid.Row="0"
                     Panel.ZIndex="10"/>


        <!-- 视频显示 -->
        <vlc:VideoView MediaPlayer="{Binding MediaPlayer}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" 
                       HorizontalContentAlignment="Center" VerticalContentAlignment="Center"
                       Grid.Row="1"
                       Panel.ZIndex="1"
                       MouseLeftButtonDown="VideoView_MouseLeftButtonDown">
        </vlc:VideoView>
        <!-- 控制面板 -->
        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Slider x:Name="PositionSlider"
                      Minimum="0"
                      Maximum="{Binding MediaPlayer.Length}"
                      Value="{Binding Position, Mode=TwoWay}"
                      Template="{StaticResource FluentSliderTemplate}" />

            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Bottom" Margin="0,0,0,10"
                    Grid.Row="1"
                    Panel.ZIndex="5">
                <TextBox Width="200" Margin="5" Text="{Binding MediaPath, UpdateSourceTrigger=PropertyChanged}" />
                <Button Content="加载" Command="{Binding LoadCommand}" Margin="5" />
                <Button Content="播放" Command="{Binding PlayCommand}" Margin="5" />
                <Button Content="暂停" Command="{Binding PauseCommand}" Margin="5" />
                <Button Content="停止" Command="{Binding StopCommand}" Margin="5" />
            </StackPanel>
        </Grid>
    </Grid>
</ui:FluentWindow>